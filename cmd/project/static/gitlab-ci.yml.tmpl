stages:
  - check
{{- if .Deployer }}
  - deploy
{{- end }}

variables:
  COMPOSER_HOME: ${CI_PROJECT_DIR}/.composer
{{- if .Deployer }}
  GIT_STRATEGY: clone
{{- end }}

cache:
  paths:
    - .composer/

validate:
  stage: check
  image:
    name: ghcr.io/shopware/shopware-cli:latest-php-8.4
    entrypoint: ["/bin/sh", "-c"]
  before_script:
    - composer install
  script:
    - shopware-cli project validate . > validate.json
    - shopware-cli project format --dry-run .
  artifacts:
    reports:
      codequality: validate.json
{{- if .Deployer }}

.configureSSHAgent: &configureSSHAgent |-
  eval $(ssh-agent -s)
  echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  mkdir -p ~/.ssh
  if ! printf '%s\n' "$DEPLOYMENT_SERVER" | grep -Eq '^[a-zA-Z0-9.-]+$'; then
    echo "Invalid DEPLOYMENT_SERVER value: $DEPLOYMENT_SERVER" >&2
    exit 1
  fi
  ssh-keyscan -H -- "$DEPLOYMENT_SERVER" >> ~/.ssh/known_hosts
  chmod 700 ~/.ssh

deploy:
  stage: deploy
  image:
    name: ghcr.io/shopware/shopware-cli:latest-php-8.4
    entrypoint: ["/bin/sh", "-c"]
  before_script:
    - *configureSSHAgent
  script:
    - shopware-cli project ci .
    - vendor/bin/dep deploy
  only:
    - main
  when: manual
{{- end }}
